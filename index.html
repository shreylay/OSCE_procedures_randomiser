<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACEM OSCE Procedure</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --border: rgba(255,255,255,0.14);
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --radius: 18px;
      --radiusPill: 999px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 720px at 18% 8%, rgba(99,102,241,0.26), transparent 58%),
        radial-gradient(900px 600px at 85% 12%, rgba(16,185,129,0.20), transparent 60%),
        radial-gradient(1100px 700px at 60% 92%, rgba(236,72,153,0.16), transparent 62%),
        var(--bg);
      min-height:100vh;
      padding: 24px 16px 420px; /* bottom padding so content doesn't hide behind tracker dock */
    }
    .container{ max-width: 1100px; margin: 0 auto; }

    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{
      margin:0;
      font-size: 1.55rem;
      letter-spacing: 0.2px;
      font-weight: 850;
    }
    .subtitle{ margin:6px 0 0; color: var(--muted); font-size: 0.98rem; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      padding: 8px 12px;
      border-radius: var(--radiusPill);
      color: var(--muted);
      font-size: 0.92rem;
      white-space: nowrap;
    }

    .card{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{ padding: 16px; }

    /* Hero / main randomiser area */
    .hero{
      min-height: 58vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap: 14px;
      padding: 26px 18px;
    }

    .hero-title{
      margin:0;
      color: var(--muted);
      font-weight: 650;
      font-size: 1.05rem;
    }

    .hero-controls{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 2px;
    }

    label{ color: var(--muted); font-size:0.92rem; }
    select, textarea, input[type="text"]{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
    }
    select:focus, textarea:focus, input:focus{
      border-color: rgba(255,255,255,0.28);
      background: rgba(255,255,255,0.08);
    }

    .hero-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-size: 1.35rem;
      font-weight: 900;
      padding: 18px 28px;
      border-radius: var(--radiusPill);
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .hero-btn:hover{
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.30);
    }
    .hero-btn:active{ transform: scale(0.985); }

    /* Procedure + timer row */
    .proc-row{
      width: min(980px, 100%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .proc-box{
      flex: 1 1 520px;
      text-align:left;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.14);
    }
    .procedure-big{
      font-size: clamp(2.0rem, 4.1vw, 3.2rem);
      font-weight: 950;
      line-height: 1.1;
      margin: 6px 0 0;
    }
    .proc-meta{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: var(--radiusPill);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 0.9rem;
    }

    .timer-box{
      flex: 0 0 280px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.14);
      text-align:left;
    }
    .timer-label{ color: var(--muted); font-size: 0.95rem; }
    .timer-display{
      font-size: 2.05rem;
      font-weight: 950;
      margin-top: 6px;
      letter-spacing: 0.8px;
    }
    .timer-actions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 750;
      transition: background .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .btn.secondary{ color: var(--muted); font-weight: 700; }
    .btn.danger{ border-color: rgba(239,68,68,0.35); }

    .notes-wrap{
      width: min(980px, 100%);
      margin-top: 10px;
      text-align:left;
    }
    textarea{ width:100%; min-height: 90px; resize: vertical; }

    .actions{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    /* Bottom tracker dock */
    .tracker-dock{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      padding: 10px 12px;
      background: rgba(10, 18, 32, 0.76);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.14);
    }
    .tracker-shell{
      max-width: 1300px;
      margin: 0 auto;
    }
    .tracker-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .tracker-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .tracker-title{
      margin:0;
      font-size: 1.0rem;
      font-weight: 850;
      color: rgba(255,255,255,0.84);
    }
    .tracker-controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .table-wrap{
      overflow:auto;
      max-height: 300px; /* height of docked table */
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align:left;
      vertical-align:top;
      font-size: 0.95rem;
    }
    th{
      position: sticky;
      top: 0;
      background: rgba(10, 18, 32, 0.92);
      backdrop-filter: blur(8px);
      z-index: 1;
      color: rgba(255,255,255,0.82);
      font-size: 0.9rem;
      letter-spacing: .2px;
    }
    .right{ text-align:right; }
    .small{ font-size: 0.88rem; color: var(--muted); }

    /* Backup */
    details{
      width: min(980px, 100%);
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,0.12);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding: 12px 14px;
      font-weight: 850;
      color: rgba(255,255,255,0.84);
      background: rgba(0,0,0,0.10);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .backup-pad{ padding: 12px 14px; }
    .backup-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>ACEM OSCE Procedure</h1>
        <div class="subtitle">Randomiser + timer + tracking (saved in this browser).</div>
      </div>
      <div class="pill" id="pillTotals">Loading‚Ä¶</div>
    </header>

    <div class="card">
      <div class="hero">
        <div class="hero-title">Generate a procedure and run an OSCE-style timed response</div>

        <div class="hero-controls">
          <label for="filterTheme">Filter:</label>
          <select id="filterTheme" aria-label="Filter theme">
            <option value="ALL" selected>All procedures</option>
            <option value="C">Common (C)</option>
            <option value="LS">Life-saving (LS)</option>
            <option value="C+LS">Common + Life-saving</option>
          </select>
        </div>

        <button class="hero-btn" id="btnRandom">üé≤ Random procedure</button>

        <div id="currentWrap" style="display:none; width:100%;">
          <div class="proc-row">
            <div class="proc-box">
              <div class="small">Generated procedure</div>
              <div class="procedure-big" id="currentName"></div>

              <div class="proc-meta">
                <span class="tag" id="tagTheme">‚Äî</span>
                <span class="tag" id="tagReviewed">Reviewed: ‚Äî</span>
                <span class="tag" id="tagLast">Last: ‚Äî</span>
                <span class="tag" id="tagDone">Done: ‚Äî</span>
              </div>
            </div>

            <div class="timer-box">
              <div class="timer-label">Timer</div>
              <div class="timer-display" id="timerDisplay">02:00</div>

              <label for="timerPreset" class="small" style="display:block; margin-top:10px;">Preset</label>
              <select id="timerPreset">
                <option value="60">1:00</option>
                <option value="90">1:30</option>
                <option value="120" selected>2:00</option>
                <option value="180">3:00</option>
                <option value="300">5:00</option>
              </select>

              <div class="timer-actions">
                <button class="btn" id="btnTimerStart">Start</button>
                <button class="btn secondary" id="btnTimerStop">Stop</button>
                <button class="btn secondary" id="btnTimerReset">Reset</button>
              </div>
            </div>
          </div>

          <div class="notes-wrap">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Key steps / pitfalls / complications / aftercare‚Ä¶"></textarea>

            <div class="actions">
              <button class="btn" id="btnReviewed">‚úÖ Mark reviewed</button>
              <button class="btn secondary" id="btnToggleDone">‚≠ê Toggle done</button>
              <button class="btn secondary" id="btnSkip">‚Ü©Ô∏é Skip</button>
            </div>
          </div>

          <details>
            <summary>Backup / restore progress</summary>
            <div class="backup-pad">
              <div class="small">Tracking is stored in this browser (localStorage). Export JSON to move to another device.</div>
              <div class="backup-actions">
                <button class="btn" id="btnExport">Export JSON</button>
                <button class="btn" id="btnImport">Import JSON</button>
                <button class="btn danger" id="btnResetAll">Reset ALL data</button>
              </div>
              <textarea id="backup" style="margin-top:10px;" placeholder="Export appears here (or paste JSON to import)."></textarea>
            </div>
          </details>
        </div>

        <div id="hintLine" class="subtitle" style="margin-top:6px;">Pick a filter (optional), then click random.</div>
      </div>
    </div>
  </div>

  <!-- Bottom tracker dock -->
  <div class="tracker-dock">
    <div class="tracker-shell">
      <div class="tracker-card">
        <div class="tracker-head">
          <h3 class="tracker-title">Tracker</h3>
          <div class="tracker-controls">
            <select id="sortMode" aria-label="Sort">
              <option value="least">Least reviewed</option>
              <option value="recent">Most recently reviewed</option>
              <option value="alpha">A ‚Üí Z</option>
              <option value="done">Done first</option>
            </select>
            <input type="text" id="search" placeholder="Search‚Ä¶" style="width:220px;">
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Procedure</th>
                <th>Theme</th>
                <th class="right">Reviewed</th>
                <th>Last</th>
                <th>Done</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // =======================
  // DATA (FACEM procedures)
  // =======================
  // Tags include: "C" (Common) and/or "LS" (Life/limb/sight saving). Also includes a domain tag, but UI filter is only C/LS as requested.
  const PROCEDURES = [
    { name: "Aseptic and sterile technique", tags: ["Infection control","C"] },

    { name: "Basic airway manoeuvres (chin lift, jaw thrust, head tilt, positioning)", tags: ["Airway","C","LS"] },
    { name: "Insertion of oropharyngeal or nasopharyngeal airway", tags: ["Airway","C","LS"] },
    { name: "Insertion of a laryngeal mask airway", tags: ["Airway","C","LS"] },
    { name: "Direct laryngoscopy + oral ETT + RSI technique (incl drugs, stylet, bougie)", tags: ["Airway","C","LS"] },
    { name: "Video laryngoscopy", tags: ["Airway","C","LS"] },
    { name: "Use of other rescue difficult airway device", tags: ["Airway","LS"] },
    { name: "Securing and caring for ETT (including during transport)", tags: ["Airway","C","LS"] },
    { name: "Cricothyroid needle insertion + jet insufflation (adult & child)", tags: ["Airway","LS"] },
    { name: "Cricothyroidotomy", tags: ["Airway","LS"] },
    { name: "Emergency replacement of blocked/dislodged tracheostomy tube", tags: ["Airway","LS"] },
    { name: "Extubation", tags: ["Airway"] },
    { name: "Indirect laryngoscopy (dental mirror exam for FB)", tags: ["Airway"] },

    { name: "Spirometry and Peak Flow measurement", tags: ["Breathing","C"] },
    { name: "Use of oxygen delivery devices", tags: ["Breathing","C","LS"] },
    { name: "Use of self-inflating bag for ventilation", tags: ["Breathing","C","LS"] },
    { name: "Use of a non-self-inflating bag for ventilation", tags: ["Breathing"] },
    { name: "Use of adult non-invasive ventilation device", tags: ["Breathing","C","LS"] },
    { name: "Use of paediatric non-invasive ventilation device", tags: ["Breathing","LS"] },
    { name: "Setting up a transport ventilator", tags: ["Breathing","C","LS"] },
    { name: "Decompression needle/finger thoracostomy", tags: ["Breathing","C","LS"] },
    { name: "Pleurocentesis", tags: ["Breathing","C"] },
    { name: "Tube thoracostomy", tags: ["Breathing","C","LS"] },

    { name: "External chest compressions (infant, paediatric, adult)", tags: ["Circulation","C","LS"] },
    { name: "Defibrillation", tags: ["Circulation","C","LS"] },
    { name: "DC cardioversion", tags: ["Circulation","C","LS"] },
    { name: "External pacing", tags: ["Circulation","LS"] },
    { name: "Venipuncture", tags: ["Circulation","C"] },
    { name: "Adult peripheral intravenous access", tags: ["Circulation","C","LS"] },
    { name: "Paediatric peripheral intravenous access", tags: ["Circulation","C","LS"] },
    { name: "Insertion of a rapid infusion catheter", tags: ["Circulation","LS"] },
    { name: "Intraosseous access", tags: ["Circulation","C","LS"] },
    { name: "Arterial puncture for blood sampling", tags: ["Circulation","C"] },
    { name: "Arterial line insertion", tags: ["Circulation","C"] },
    { name: "Preparation & operation of transport monitoring equipment", tags: ["Circulation","C"] },
    { name: "Insertion of a central venous line", tags: ["Circulation","C"] },
    { name: "Emergency pericardiocentesis", tags: ["Circulation","LS"] },
    { name: "Resuscitative thoracotomy", tags: ["Circulation","LS"] },
    { name: "Insertion of a temporary pacing wire", tags: ["Circulation","LS"] },

    { name: "Preparation of an intravenous fluid or blood product line", tags: ["Fluids & tubes","C"] },
    { name: "Insertion of a nasogastric tube or orogastric tube", tags: ["Fluids & tubes","C"] },
    { name: "Insertion of an adult urinary catheter", tags: ["Fluids & tubes","C"] },
    { name: "Insertion of an infant urinary catheter", tags: ["Fluids & tubes","C"] },
    { name: "Suprapubic aspiration of urine in an infant", tags: ["Fluids & tubes","C"] },
    { name: "Insertion of a suprapubic catheter", tags: ["Fluids & tubes"] },
    { name: "Replacement of a suprapubic catheter", tags: ["Fluids & tubes","C"] },
    { name: "Abdominal paracentesis and insertion of drain", tags: ["Fluids & tubes","C"] },
    { name: "Insertion of oesophageal & gastric balloon devices", tags: ["Fluids & tubes","LS"] },
    { name: "Emergency replacement of a dislodged gastrostomy tube", tags: ["Fluids & tubes","C"] },

    { name: "Sizing and application of a rigid cervical collar", tags: ["Ortho & neuro","C","LS"] },
    { name: "In-line cervical spine immobilisation", tags: ["Ortho & neuro","C","LS"] },
    { name: "Full spinal immobilisation, log roll, and transfer", tags: ["Ortho & neuro","C","LS"] },
    { name: "Emergent fracture/dislocation reduction", tags: ["Ortho & neuro","C","LS"] },
    { name: "Joint reduction ‚Äì digits", tags: ["Ortho & neuro","C"] },
    { name: "Joint reduction ‚Äì major joints", tags: ["Ortho & neuro","C","LS"] },
    { name: "Fracture/joint immobilisation techniques (including limb splinting)", tags: ["Ortho & neuro","C"] },
    { name: "Fracture/joint immobilisation ‚Äì backslab application", tags: ["Ortho & neuro","C"] },
    { name: "Application of sling/collar and cuff", tags: ["Ortho & neuro","C"] },
    { name: "Insertion of a fascial intra-compartmental monitor", tags: ["Ortho & neuro"] },
    { name: "Application of a pelvic binding device", tags: ["Ortho & neuro","C","LS"] },
    { name: "Application of traction splinting devices", tags: ["Ortho & neuro","C","LS"] },
    { name: "Arthrocentesis (knee)", tags: ["Ortho & neuro","C"] },

    { name: "Administration of procedural sedation", tags: ["Sedation","C"] },
    { name: "Administration of chemical restraint", tags: ["Sedation","C"] },

    { name: "Use of topical anaesthesia", tags: ["Regional anaesthesia","C"] },
    { name: "Direct infiltration of local anaesthetic", tags: ["Regional anaesthesia","C"] },
    { name: "Digital nerve block", tags: ["Regional anaesthesia","C"] },
    { name: "Femoral nerve and fascia iliaca block", tags: ["Regional anaesthesia","C"] },
    { name: "Other peripheral nerve blocks", tags: ["Regional anaesthesia"] },
    { name: "Intravenous anaesthesia and Bier‚Äôs block", tags: ["Regional anaesthesia"] },

    { name: "Basic skin suturing techniques", tags: ["Wounds","C"] },
    { name: "Alternate skin closure (tissue adhesive, staples)", tags: ["Wounds","C"] },
    { name: "Advanced suturing techniques", tags: ["Wounds","C"] },
    { name: "Wound exploration, cleaning, irrigation, and debridement", tags: ["Wounds","C"] },
    { name: "Superficial open wound dressing", tags: ["Wounds","C"] },
    { name: "Open wound packing", tags: ["Wounds","C"] },

    { name: "Burn first aid", tags: ["Burns","C"] },
    { name: "Primary burn dressing", tags: ["Burns","C"] },
    { name: "Escharotomy", tags: ["Burns","LS"] },

    { name: "Removal of superficial & subcutaneous foreign bodies", tags: ["Minor surgery","C"] },
    { name: "Incision and drainage of simple, superficial abscesses", tags: ["Minor surgery","C"] },
    { name: "Drainage of a paronychia", tags: ["Minor surgery","C"] },
    { name: "Drainage of a subungual haematoma", tags: ["Minor surgery","C"] },
    { name: "Incision and drainage of a thrombosed external haemorrhoid", tags: ["Minor surgery","C"] },
    { name: "Drainage of peritonsillar abscess", tags: ["Minor surgery"] },
    { name: "Nail bed repair", tags: ["Minor surgery","C"] },

    { name: "Vaginal speculum insertion", tags: ["O&G","C"] },
    { name: "Removal of products of conception from cervical os", tags: ["O&G","C","LS"] },
    { name: "Use of foetal doppler", tags: ["O&G","C"] },
    { name: "Spontaneous vaginal delivery", tags: ["O&G","LS"] },

    { name: "Collection of blood culture", tags: ["Microbiology","C"] },
    { name: "Lumbar puncture + measurement of CSF opening pressure", tags: ["Microbiology","C"] },
    { name: "Paediatric non-invasive urine collection", tags: ["Microbiology","C"] },
    { name: "Collection of swabs", tags: ["Microbiology","C"] },
    { name: "Nasopharyngeal aspirate collection", tags: ["Microbiology","C"] },

    { name: "Removal of nasal foreign bodies", tags: ["ENT","C"] },
    { name: "Removal of aural foreign bodies", tags: ["ENT","C"] },
    { name: "Removal of laryngeal foreign bodies", tags: ["ENT","C"] },
    { name: "Nasal speculum insertion", tags: ["ENT","C"] },
    { name: "Nasal cautery", tags: ["ENT","C"] },
    { name: "Anterior nasal packing", tags: ["ENT","C","LS"] },
    { name: "Posterior nasal packing", tags: ["ENT","LS"] },
    { name: "Aural toilet", tags: ["ENT","C"] },
    { name: "Aural wick insertion", tags: ["ENT","C"] },

    { name: "Removal of corneal foreign bodies", tags: ["Ophthalmology","C"] },
    { name: "Direct ophthalmoscopy", tags: ["Ophthalmology","C"] },
    { name: "Use of a slit lamp in the eye examination", tags: ["Ophthalmology","C"] },
    { name: "Tonometry", tags: ["Ophthalmology","C"] },
    { name: "Eye irrigation", tags: ["Ophthalmology","C","LS"] },
    { name: "Application of an eye pad or shield", tags: ["Ophthalmology","C"] },
    { name: "Lateral canthotomy", tags: ["Ophthalmology","LS"] },

    { name: "Joint reduction: temporo-mandibular joint", tags: ["Dental","C"] },
    { name: "Enlocation avulsed/extruded/intruded/laterally injured tooth", tags: ["Dental","C"] },
    { name: "Temporary stabilisation of injured tooth", tags: ["Dental","C"] },
    { name: "Haemostasis following dental extraction", tags: ["Dental","C"] },

    { name: "Focused Echocardiography in Life Support (FELS)", tags: ["Ultrasound","C"] },
    { name: "FAST or eFAST", tags: ["Ultrasound","C"] },
    { name: "Pneumothorax / haemothorax detection", tags: ["Ultrasound","C"] },
    { name: "Detection & characterisation of an abdominal aortic aneurysm", tags: ["Ultrasound","C"] },
    { name: "Guided peripheral vascular access", tags: ["Ultrasound","C"] },
    { name: "Guided central vascular access", tags: ["Ultrasound","C"] },
    { name: "Ultrasound guided nerve blocks", tags: ["Ultrasound"] },
    { name: "Identification of distended bladder", tags: ["Ultrasound","C"] },

    { name: "Pressure immobilisation bandage", tags: ["Toxicology","C","LS"] },
    { name: "Gastric decontamination / whole bowel irrigation", tags: ["GI decontamination","LS"] },

    { name: "Basic warming and cooling techniques (external methods, IV fluids)", tags: ["Environmental","C","LS"] },
    { name: "Advanced warming and cooling techniques", tags: ["Environmental","LS"] }
  ];

  // =======================
  // STATE / STORAGE
  // =======================
  const KEY = "acem_osce_procedure_v2";
  let state = loadState();
  let current = null;

  const $ = (id) => document.getElementById(id);

  function loadState(){
    const raw = localStorage.getItem(KEY);
    if (!raw){
      const fresh = { procedures: PROCEDURES, meta: {}, log: [] };
      saveState(fresh);
      return fresh;
    }
    try{
      const parsed = JSON.parse(raw);
      if (!parsed.procedures || !Array.isArray(parsed.procedures)) throw new Error("bad");
      if (!parsed.meta) parsed.meta = {};
      if (!parsed.log) parsed.log = [];
      // If you ever update the PROCEDURES list, merge in any new ones:
      const byName = new Map(parsed.procedures.map(p => [p.name, p]));
      for (const p of PROCEDURES){
        if (!byName.has(p.name)) byName.set(p.name, p);
      }
      parsed.procedures = Array.from(byName.values());
      return parsed;
    } catch(e){
      localStorage.removeItem(KEY);
      return loadState();
    }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function ensureMeta(name){
    if (!state.meta[name]) state.meta[name] = { count: 0, last: null, done: false };
    return state.meta[name];
  }

  function formatDate(iso){
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function computeTotals(){
    const total = state.procedures.length;
    let reviewed = 0, done = 0;
    for (const p of state.procedures){
      const m = ensureMeta(p.name);
      if (m.count > 0) reviewed++;
      if (m.done) done++;
    }
    $("pillTotals").textContent = `${total} procedures ‚Ä¢ Reviewed: ${reviewed} ‚Ä¢ Done: ${done}`;
  }

  function themeLabelFor(name){
    const p = state.procedures.find(x => x.name === name);
    const tags = p ? p.tags : [];
    const hasC = tags.includes("C");
    const hasLS = tags.includes("LS");
    if (hasC && hasLS) return "Common + Life-saving";
    if (hasLS) return "Life-saving";
    if (hasC) return "Common";
    return "‚Äî";
  }

  function filterByTheme(list){
    const theme = $("filterTheme").value;
    if (theme === "ALL") return list;
    if (theme === "C") return list.filter(p => p.tags.includes("C"));
    if (theme === "LS") return list.filter(p => p.tags.includes("LS"));
    if (theme === "C+LS") return list.filter(p => p.tags.includes("C") && p.tags.includes("LS"));
    return list;
  }

  // Weighted pick to bias toward less reviewed
  function pickRandom(){
    let list = state.procedures.slice();
    list = filterByTheme(list);

    if (!list.length) return null;

    const weights = list.map(p => 1 / (ensureMeta(p.name).count + 1));
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random() * total;
    for (let i=0;i<list.length;i++){
      r -= weights[i];
      if (r <= 0) return list[i].name;
    }
    return list[list.length-1].name;
  }

  function renderCurrent(){
    if (!current){
      $("currentWrap").style.display = "none";
      $("hintLine").style.display = "block";
      return;
    }
    $("hintLine").style.display = "none";
    $("currentWrap").style.display = "block";
    $("currentName").textContent = current;

    const m = ensureMeta(current);
    $("tagTheme").textContent = `Theme: ${themeLabelFor(current)}`;
    $("tagReviewed").textContent = `Reviewed: ${m.count}`;
    $("tagLast").textContent = `Last: ${formatDate(m.last)}`;
    $("tagDone").textContent = `Done: ${m.done ? "‚úÖ" : "‚Äî"}`;
    $("btnToggleDone").textContent = m.done ? "‚≠ê Mark not-done" : "‚≠ê Mark done";
  }

  function renderTracker(){
    const q = $("search").value.trim().toLowerCase();
    const mode = $("sortMode").value;

    let rows = state.procedures
      .filter(p =>
        p.name.toLowerCase().includes(q) ||
        themeLabelFor(p.name).toLowerCase().includes(q)
      )
      .map(p => ({ p, m: ensureMeta(p.name) }));

    const sorter = {
      least: (a,b) => a.m.count - b.m.count || a.p.name.localeCompare(b.p.name),
      recent:(a,b) => (b.m.last || "").localeCompare(a.m.last || "") || a.p.name.localeCompare(b.p.name),
      alpha: (a,b) => a.p.name.localeCompare(b.p.name),
      done:  (a,b) => (b.m.done - a.m.done) || a.p.name.localeCompare(b.p.name)
    }[mode];

    rows.sort(sorter);

    $("tbody").innerHTML = rows.map(({p,m}) => `
      <tr>
        <td>${escapeHtml(p.name)}</td>
        <td class="small">${escapeHtml(themeLabelFor(p.name))}</td>
        <td class="right">${m.count}</td>
        <td class="small">${escapeHtml(formatDate(m.last))}</td>
        <td>${m.done ? "‚úÖ" : "‚Äî"}</td>
        <td class="right">
          <button class="btn" onclick="quickReview(${JSON.stringify(p.name)})">+1</button>
          <button class="btn secondary" onclick="toggleDone(${JSON.stringify(p.name)})">Done</button>
        </td>
      </tr>
    `).join("");

    computeTotals();
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function markReviewed(name, notes){
    const m = ensureMeta(name);
    m.count += 1;
    m.last = new Date().toISOString();
    state.log.push({ name, when: m.last, notes: notes || "" });
    if (state.log.length > 2000) state.log = state.log.slice(-2000);
    saveState(state);
    renderCurrent();
    renderTracker();
  }

  function toggleDone(name){
    const m = ensureMeta(name);
    m.done = !m.done;
    saveState(state);
    renderCurrent();
    renderTracker();
  }

  // Expose for table buttons
  window.quickReview = (name) => markReviewed(name, "");
  window.toggleDone = (name) => toggleDone(name);

  // =======================
  // TIMER
  // =======================
  let timerId = null;
  let timerRemaining = 120; // seconds

  function fmtTimer(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function renderTimer(){
    $("timerDisplay").textContent = fmtTimer(timerRemaining);
  }
  function timerResetFromPreset(){
    const val = Number($("timerPreset").value || 120);
    timerRemaining = val;
    renderTimer();
  }
  function timerStart(){
    if (timerId) return;
    timerId = setInterval(() => {
      timerRemaining -= 1;
      renderTimer();
      if (timerRemaining <= 0){
        timerStop();
        timerRemaining = 0;
        renderTimer();
        try { navigator.vibrate?.(200); } catch {}
        alert("Time!");
      }
    }, 1000);
  }
  function timerStop(){
    if (!timerId) return;
    clearInterval(timerId);
    timerId = null;
  }

  // =======================
  // BACKUP / RESTORE
  // =======================
  function exportJson(){
    $("backup").value = JSON.stringify(state, null, 2);
  }
  function importJson(){
    const txt = $("backup").value.trim();
    if (!txt) return alert("Paste JSON first.");
    try{
      const incoming = JSON.parse(txt);
      if (!incoming || !Array.isArray(incoming.procedures) || typeof incoming.meta !== "object"){
        return alert("Backup format not recognised.");
      }
      state = incoming;
      if (!state.log) state.log = [];
      saveState(state);
      current = null;
      renderCurrent();
      renderTracker();
      alert("Imported.");
    } catch(e){
      alert("Invalid JSON.");
    }
  }
  function resetAll(){
    if (!confirm("Reset ALL progress in this browser?")) return;
    localStorage.removeItem(KEY);
    state = loadState();
    current = null;
    renderCurrent();
    renderTracker();
    exportJson();
  }

  // =======================
  // EVENTS
  // =======================
  $("btnRandom").addEventListener("click", () => {
    const picked = pickRandom();
    if (!picked){
      return alert("No procedures match that filter.");
    }
    current = picked;
    $("notes").value = "";
    renderCurrent();

    // reset timer to preset each time you generate a new procedure
    timerStop();
    timerResetFromPreset();
  });

  $("btnSkip").addEventListener("click", () => $("btnRandom").click());

  $("btnReviewed").addEventListener("click", () => {
    if (!current) return;
    markReviewed(current, $("notes").value);
  });

  $("btnToggleDone").addEventListener("click", () => {
    if (!current) return;
    toggleDone(current);
  });

  $("filterTheme").addEventListener("change", () => {
    // Filter affects random picks; also update tracker view if you search by theme labels
    renderTracker();
  });

  $("sortMode").addEventListener("change", renderTracker);
  $("search").addEventListener("input", renderTracker);

  $("timerPreset").addEventListener("change", () => {
    timerStop();
    timerResetFromPreset();
  });
  $("btnTimerStart").addEventListener("click", timerStart);
  $("btnTimerStop").addEventListener("click", timerStop);
  $("btnTimerReset").addEventListener("click", () => {
    timerStop();
    timerResetFromPreset();
  });

  $("btnExport").addEventListener("click", exportJson);
  $("btnImport").addEventListener("click", importJson);
  $("btnResetAll").addEventListener("click", resetAll);

  // =======================
  // INIT
  // =======================
  timerResetFromPreset();
  renderCurrent();
  renderTracker();
</script>
</body>
</html>
